# =================================================================
# Dockerfile para Agentes Background con Claude CLI - TESTING INTEGRAL
# Optimizado para VPS Hetzner con Ubuntu 24.04.2 LTS
# =================================================================

FROM ubuntu:24.04

# Evitar prompts interactivos durante instalaciÃ³n
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC

# Instalar dependencias del sistema
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    git \
    nodejs \
    npm \
    python3 \
    python3-pip \
    python3-venv \
    vim \
    nano \
    jq \
    htop \
    ca-certificates \
    gnupg \
    lsb-release \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Crear directorios estÃ¡ndar
RUN mkdir -p /usr/local/bin /workspace /logs /tmp/agent
RUN chmod 755 /workspace /logs /tmp/agent

# Configurar PATH para binarios montados desde host
ENV PATH="/usr/local/bin:/usr/bin:/bin"

# Variables de entorno para agente
ENV AGENT_MODE="production"
ENV CLAUDE_CLI_PATH="/usr/local/bin/claude"
ENV WORKSPACE_PATH="/workspace"

# Script de entrada mejorado para testing integral
RUN cat > /entrypoint.sh << 'EOF'
#!/bin/bash
set -e

echo "ğŸ¤– ==================================================================="
echo "ğŸ¤– AGENTE BACKGROUND - TESTING INTEGRAL"
echo "ğŸ¤– ==================================================================="
echo "ğŸ“‚ Workspace: $(pwd)"
echo "ğŸ• Iniciado: $(date)"
echo "ğŸ’¾ Memoria disponible: $(free -h | grep Mem | awk '{print $7}')"
echo "ğŸ–¥ï¸  CPU cores: $(nproc)"

# Verificar montajes crÃ­ticos
echo "ğŸ” Verificando montajes..."
if [ -f "/usr/local/bin/claude" ]; then
    echo "âœ… Claude CLI binario encontrado"
    ls -la /usr/local/bin/claude
else
    echo "âŒ Claude CLI binario NO encontrado en /usr/local/bin/claude"
    echo "   Verificar que el volume mount estÃ© configurado correctamente"
fi

if [ -d "/root/.claude" ]; then
    echo "âœ… Claude CLI auth directory encontrado"
    ls -la /root/.claude/
else
    echo "âŒ Claude CLI auth directory NO encontrado en /root/.claude"
    echo "   Verificar que el volume mount estÃ© configurado correctamente"
fi

# Verificar Claude CLI
echo "ğŸ” Verificando autenticaciÃ³n Claude CLI..."
if command -v claude >/dev/null 2>&1; then
    echo "âœ… Claude CLI disponible en PATH"
    if claude auth status >/dev/null 2>&1; then
        echo "âœ… Claude CLI autenticado correctamente"
        claude auth status
    else
        echo "âš ï¸  Claude CLI no autenticado - verificar montaje de /root/.claude"
        echo "   Status: $(claude auth status 2>&1 || echo 'Error')"
    fi
else
    echo "âŒ Claude CLI no disponible en PATH"
    echo "   PATH actual: $PATH"
    echo "   Binarios en /usr/local/bin: $(ls -la /usr/local/bin/ || echo 'ninguno')"
fi

# Verificar contexto de tarea
echo "ğŸ“‹ Verificando contexto de tarea..."
if [ -f "task-context.json" ]; then
    echo "âœ… Contexto de tarea encontrado:"
    jq -r '.title // "Sin tÃ­tulo"' task-context.json 2>/dev/null || echo "Error leyendo contexto"
else
    echo "âš ï¸  No se encontrÃ³ task-context.json"
fi

# Verificar repositorios
if [ -d "repositories" ]; then
    echo "âœ… Directorio de repositorios encontrado:"
    ls -la repositories/ | head -5
else
    echo "âš ï¸  No se encontraron repositorios clonados"
fi

# Verificar script de ejecuciÃ³n
if [ -f "execute.sh" ]; then
    echo "âœ… Script de ejecuciÃ³n encontrado"
    chmod +x execute.sh
else
    echo "âš ï¸  No se encontrÃ³ execute.sh"
fi

echo "ğŸš€ Agente listo para ejecutar tareas"
echo "ğŸ“‹ Ejecutando comando: $@"

# Ejecutar comando pasado como parÃ¡metros
exec "$@"
EOF

RUN chmod +x /entrypoint.sh

# Crear script de testing especÃ­fico
RUN cat > /test-agent.sh << 'EOF'
#!/bin/bash
echo "ğŸ§ª INICIANDO TEST INTEGRAL DEL AGENTE"

# Test 1: Claude CLI disponibilidad
echo "Test 1: Claude CLI disponibilidad"
which claude && echo "âœ… Claude en PATH" || echo "âŒ Claude NO en PATH"

# Test 2: AutenticaciÃ³n
echo "Test 2: AutenticaciÃ³n Claude"
claude auth status && echo "âœ… Autenticado" || echo "âŒ No autenticado"

# Test 3: Funcionalidad bÃ¡sica
echo "Test 3: Funcionalidad bÃ¡sica"
echo "Hello Claude!" | claude --print && echo "âœ… Funciona" || echo "âŒ Error"

# Test 4: Contexto de workspace
echo "Test 4: Contexto disponible"
ls -la . && echo "âœ… Workspace OK" || echo "âŒ Workspace error"

echo "ğŸ§ª TEST COMPLETADO"
EOF

RUN chmod +x /test-agent.sh

# Punto de entrada y comando por defecto
WORKDIR /workspace
ENTRYPOINT ["/entrypoint.sh"]
CMD ["bash"]

# Metadata para debugging
LABEL version="1.0.0"
LABEL description="Claude Agent Container for Integral Testing"
LABEL maintainer="Telegram Task Agent System"